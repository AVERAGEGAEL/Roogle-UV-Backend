<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Roogle UV Debug Proxy</title>
</head>
<body style="background:#111;color:#eee;font:16px sans-serif;padding:20px;">
  <h1>Roogle UV Debug</h1>
  <div id="log"></div>

  <!-- External UV files from CDN (you can later replace with your local ones if you prefer) -->
  <script src="https://cdn.jsdelivr.net/gh/titaniumnetwork-dev/Ultraviolet-Node/public/uv.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/titaniumnetwork-dev/Ultraviolet-Node/public/uv.config.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/titaniumnetwork-dev/Ultraviolet-Node/public/uv.handler.js"></script>

  <script>
    function log(msg) {
      console.log(msg);
      const d = document.getElementById('log');
      d.innerHTML += msg + '<br>';
    }

    window.addEventListener('load', async () => {
      log('Page fully loaded');

      const targetUrl = new URLSearchParams(location.search).get('url');
      if (!targetUrl) return log('❗ Missing ?url parameter.');

      log('Target URL: ' + targetUrl);

      if (!('serviceWorker' in navigator)) {
        return log('❗ Service workers not supported.');
      }

      // Wait for Ultraviolet + config to load
      for (let i = 0; i < 40; i++) {
        if (typeof Ultraviolet !== 'undefined' && typeof __uv$config !== 'undefined') break;
        await new Promise(r => setTimeout(r, 100));
      }

      if (typeof Ultraviolet === 'undefined') return log('❗ Ultraviolet is still undefined');
      if (typeof __uv$config === 'undefined') return log('❗ __uv$config is still undefined');

      log('Ultraviolet + config loaded.');

      try {
        const reg = await navigator.serviceWorker.register(__uv$config.sw, {
          scope: __uv$config.prefix,
        });
        log('✅ Service worker registered: ' + reg.scope);
      } catch (e) {
        return log('❗ Failed to register service worker: ' + e);
      }

      let uv;
      try {
        uv = new Ultraviolet(__uv$config);
        log('✅ Created UV instance');
      } catch (e) {
        return log('❗ UV constructor error: ' + e);
      }

      if (typeof uv.init !== 'function') return log('❗ uv.init is not a function');

      try {
        await uv.init();
        log('✅ UV initialized');
      } catch (e) {
        return log('❗ uv.init failed: ' + e);
      }

      const iframe = document.createElement('iframe');
      iframe.style = 'width:100%;height:80vh;border:none;';
      document.body.appendChild(iframe);
      log('Iframe created');

      try {
        uv.navigate(iframe, targetUrl);
        log('✅ UV navigating to ' + targetUrl);
      } catch (e) {
        log('❗ uv.navigate failed: ' + e);
      }
    });
  </script>
</body>
</html>
